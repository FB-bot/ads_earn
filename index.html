<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Earning Technology</title>

  <!-- 1. Monetage SDK Script (use https explicitly) -->
  <script src="https://libtl.com/sdk.js" data-zone="10199498" data-sdk="show_10199498" defer></script>

  <!-- 2. Telegram Web App Script -->
  <script src="https://telegram.org/js/telegram-web-app.js" defer></script>

  <!-- ================= New Modern Glassy UI CSS (Option A) with profile styles ================= -->
  <style>
  /* ========== Modern Glassy UI (no logic change) ========== */

  :root {
    /* primary palette */
    --bg-gradient: radial-gradient(circle at top, #1b2945 0, #050816 55%, #020617 100%);
    --card-bg: rgba(15, 23, 42, 0.85);
    --card-border: rgba(148, 163, 184, 0.25);
    --accent: #38bdf8;
    --accent-strong: #0ea5e9;
    --accent-soft: rgba(56, 189, 248, 0.16);
    --success-color: #22c55e;
    --danger-color: #f97373;
    --warning-color: #fbbf24;
    --muted: #9ca3af;
    --text-main: #e5f0ff;
    --radius-lg: 18px;
    --radius-md: 14px;
    --shadow-soft: 0 22px 60px rgba(15, 23, 42, 0.75);
  }

  /* --- Page base --- */

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, -system-ui, sans-serif;
    background: var(--bg-gradient);
    color: var(--text-main);
    padding: 26px 16px 110px;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Container */

  .container {
    width: 100%;
    max-width: 520px;
    transform: translateZ(0);
  }

  /* Views */

  .view {
    width: 100%;
    display: none;
    animation: fadeIn 0.28s ease-out;
  }

  #home-view {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Header */

  .header {
    margin-bottom: 16px;
    text-align: left;
  }

  .header .profile-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .profile-pic {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.06);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 8px 24px rgba(2,6,23,0.6);
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .profile-pic img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .profile-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .profile-name {
    font-size: 16px;
    font-weight: 800;
    color: #f8fafc;
    letter-spacing: -0.2px;
  }

  .profile-sub {
    font-size: 12px;
    color: var(--muted);
  }

  .header h1 {
    margin: 0;
    font-size: 30px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: #f9fafb;
    text-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
  }

  .header p {
    margin: 6px 0 0;
    color: var(--muted);
    font-size: 14px;
  }

  /* Cards (glassy) */

  .card {
    background: linear-gradient(145deg, rgba(15, 23, 42, 0.93), rgba(15, 23, 42, 0.88));
    border-radius: var(--radius-lg);
    padding: 22px 20px;
    margin-bottom: 20px;
    border: 1px solid var(--card-border);
    box-shadow: var(--shadow-soft);
    backdrop-filter: blur(12px) saturate(130%);
    -webkit-backdrop-filter: blur(12px) saturate(130%);
  }

  .card h2 {
    margin: 0 0 10px 0;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    font-weight: 600;
  }

  /* Balance */

  .balance-amount {
    font-size: 44px;
    font-weight: 800;
    margin: 2px 0 8px;
    color: #f9fafb;
    text-shadow: 0 14px 40px rgba(15, 23, 42, 0.95);
  }

  /* Ad info grid */

  .ad-info-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
    margin-top: 4px;
  }

  .ad-info-item {
    border-radius: 12px;
    padding: 10px 12px;
    background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), rgba(15, 23, 42, 0.98));
    border: 1px solid rgba(148, 163, 184, 0.2);
  }

  .ad-info-item h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
    color: #e5f0ff;
  }

  .ad-info-item p {
    margin: 4px 0 0;
    font-size: 12px;
    color: var(--muted);
  }

  /* Buttons */

  .ad-buttons {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-bottom: 18px;
  }

  .btn {
    width: 100%;
    border: none;
    outline: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border-radius: var(--radius-md);
    padding: 13px 14px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    background: linear-gradient(135deg, var(--accent), var(--accent-strong));
    color: #031824;
    box-shadow: 0 18px 40px rgba(8, 47, 73, 0.85);
    transition:
      transform 0.16s cubic-bezier(.19, .95, .2, 1),
      box-shadow 0.16s cubic-bezier(.19, .95, .2, 1),
      opacity 0.12s ease-out;
  }

  .btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 24px 60px rgba(8, 47, 73, 0.95);
  }

  .btn:active {
    transform: translateY(-1px) scale(0.995);
    box-shadow: 0 16px 36px rgba(8, 47, 73, 0.8);
  }

  /* Withdraw main button */

  #mainWithdrawBtn {
    margin-top: 2px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: #022c17;
    box-shadow: 0 20px 55px rgba(22, 163, 74, 0.65);
  }

  .btn:disabled,
  #mainWithdrawBtn:disabled {
    opacity: 0.42;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Inputs */

  .input-group {
    margin-bottom: 18px;
    text-align: left;
  }

  .input-group label {
    display: block;
    margin-bottom: 7px;
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
  }

  .input-group input {
    width: 100%;
    padding: 13px 12px;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background-color: rgba(15, 23, 42, 0.95);
    color: #e5e7eb;
    font-size: 15px;
    outline: none;
    box-sizing: border-box;
    transition: border-color 0.14s ease, box-shadow 0.14s ease, background-color 0.14s ease;
  }

  .input-group input::placeholder {
    color: rgba(148, 163, 184, 0.8);
  }

  .input-group input:focus {
    border-color: var(--accent-strong);
    box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6), 0 10px 30px rgba(15, 23, 42, 0.9);
  }

  /* Referral link */

  #referralLink {
    margin-top: 12px;
    padding: 11px 12px;
    border-radius: 12px;
    border: 1px dashed rgba(148, 163, 184, 0.5);
    background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), rgba(15, 23, 42, 0.95));
    font-size: 13px;
    color: #e5f0ff;
    word-break: break-all;
    cursor: pointer;
    user-select: all;
    transition: background 0.15s ease, border-color 0.15s ease, transform 0.12s ease;
  }

  #referralLink:hover {
    background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), rgba(15, 23, 42, 1));
    border-color: var(--accent-strong);
    transform: translateY(-1px);
  }

  /* Status messages */

  .status-message {
    position: fixed;
    left: 50%;
    bottom: 84px;
    transform: translateX(-50%);
    width: 90%;
    max-width: 480px;
    padding: 11px 14px;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 600;
    display: none;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(18px) saturate(140%);
    -webkit-backdrop-filter: blur(18px) saturate(140%);
    border-left: 4px solid transparent;
  }

  /* ‡¶è‡¶á ‡¶§‡¶ø‡¶®‡¶ü‡¶æ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ JS-‡¶è ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶§‡¶æ‡¶á ‡¶∞‡¶Ç ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶≤‡¶æ‡¶Æ */

  .success {
    display: block;
    background: rgba(34, 197, 94, 0.1);
    border-left-color: var(--success-color);
    color: #bbf7d0;
  }

  .error {
    display: block;
    background: rgba(248, 113, 113, 0.16);
    border-left-color: var(--danger-color);
    color: #fecaca;
  }

  .info {
    display: block;
    background: rgba(56, 189, 248, 0.18);
    border-left-color: var(--accent-strong);
    color: #e0f2fe;
  }

  /* Footer nav */

  .footer-nav {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 16px;
    width: calc(100% - 32px);
    max-width: 520px;
    padding: 8px 8px;
    border-radius: 18px;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
    border: 1px solid rgba(148, 163, 184, 0.4);
    display: flex;
    justify-content: space-around;
    box-shadow: 0 18px 48px rgba(15, 23, 42, 0.9);
    z-index: 999;
  }

  .nav-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 11px;
    font-weight: 600;
    padding: 6px 10px;
    border-radius: 12px;
    cursor: pointer;
    gap: 4px;
    transition: color 0.16s ease, transform 0.16s ease, background 0.16s ease;
  }

  .nav-btn .icon {
    width: 24px;
    height: 24px;
  }

  .nav-btn.active {
    color: var(--accent);
    background: rgba(15, 23, 42, 0.95);
    transform: translateY(-3px);
  }

  .nav-btn:hover:not(.active) {
    color: #e5f0ff;
  }

  /* Admin panel */

  .admin-panel {
    margin-top: 26px;
    padding: 13px 12px;
    border-radius: 12px;
    border: 1px solid rgba(250, 204, 21, 0.5);
    background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.12), rgba(15, 23, 42, 0.98));
  }

  .admin-panel h3 {
    margin: 0 0 6px;
    font-size: 13px;
    color: #fde68a;
  }

  /* Responsive tweaks */

  @media (max-width: 420px) {
    body {
      padding-top: 20px;
    }
    .header h1 {
      font-size: 24px;
    }
    .balance-amount {
      font-size: 36px;
    }
    .btn {
      font-size: 15px;
      padding: 12px 12px;
    }
    .profile-pic { width:48px; height:48px; border-radius:10px; }
  }
  </style>
  <!-- ================= End CSS ================= -->
</head>
<body>
  <!-- Note: some third-party ad scripts can be hostile. Host a backend to validate and process payouts; keep third-party scripts minimal. -->
  <script src="https://pl26604097.profitableratecpm.com/0f/56/94/0f5694f9b53dd9db6b20e82218735b99.js" defer></script>

  <div class="container">
    <!-- Home / Task View -->
    <div id="home-view" class="view">
      <div class="header">
        <!-- NEW: profile row (added without changing other logic) -->
        <div class="profile-row" id="profileRow" style="display:none;">
          <div class="profile-pic" id="profilePic"><img src="" alt="profile"></div>
          <div class="profile-info">
            <div class="profile-name" id="profileName">User Name</div>
            <div class="profile-sub" id="profileSub">@username</div>
          </div>
        </div>
        <!-- end new -->

        <h1>Smart Earning</h1><p>Watch Ads and Earn USDT</p>
      </div>

      <div class="card">
        <h2>Current Balance</h2>
        <div class="balance-amount" id="balanceDisplay">USDT 0.00</div>
        <div class="ad-info-grid">
          <div class="ad-info-item"><h3 id="adCountDisplay">0</h3><p>Total Ads Watched</p></div>
          <div class="ad-info-item"><h3 id="dailyAdCountDisplay">0 / 1000</h3><p>Today's Ads</p></div>
        </div>
      </div>

      <div class="ad-buttons">
        <button class="btn" id="rewardedBtn">Watch Ad (+0.01 USDT)</button>
      </div>

      <button class="btn" id="mainWithdrawBtn" disabled>Reach 10.00 USDT to Withdraw</button>
    </div>

    <!-- Withdraw View -->
    <div id="withdraw-view" class="view">
      <div class="header"><h1>Withdraw</h1><p>Request your earnings</p></div>

      <div class="card">
        <h2>Your Balance</h2>
        <div class="balance-amount" id="withdrawBalanceDisplay">USDT 0.00</div>
        <p style="color: var(--muted); margin-top: 15px;">Minimum withdrawal is 10.00 USDT.</p>
      </div>

      <div class="card">
        <h2>Payment Details</h2>
        <div class="input-group">
          <label for="paymentAddress">Your USDT Wallet Address (TRC20)</label>
          <input type="text" id="paymentAddress" placeholder="e.g., T... (TRC20 Address)" autocomplete="off" />
        </div>
        <button class="btn" id="finalWithdrawBtn" disabled>Withdraw</button>
      </div>
    </div>

    <!-- Referral View -->
    <div id="referral-view" class="view">
      <div class="header"><h1>Referrals</h1><p>Invite friends and earn more!</p></div>

      <div class="card">
        <h2>Your Referral Stats</h2>
        <div class="ad-info-grid">
          <div class="ad-info-item"><h3 id="referralCountDisplay">0</h3><p>Total Referrals</p></div>
          <div class="ad-info-item"><h3 id="referralBonusDisplay">USDT 0.00</h3><p>Referral Earnings</p></div>
        </div>
      </div>

      <div class="card">
        <h2>Your Referral Link</h2>
        <p>Share this link with your friends. You get 0.5 USDT for each verified friend who joins!</p>
        <div id="referralLink" title="Click to copy">No link yet</div>
        <p style="font-size:12px; color:var(--muted); margin-top:15px;">Note: Referral rewards require backend processing and will be credited after verification.</p>
      </div>
    </div>

    <!-- Common Elements -->
    <div class="status-message" id="statusMessage"></div>
    <div class="admin-panel" id="adminPanel"><h3>üëë Admin Panel</h3><p id="userInfo"></p></div>
  </div>

  <!-- Footer Navigation -->
  <footer class="footer-nav">
    <button class="nav-btn active" id="navHome"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span><span>Home</span></button>
    <button class="nav-btn" id="navWithdraw"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.31 8.91a1 1 0 0 0-1.42 0l-4.24 4.24-2.12-2.12a1 1 0 1 0-1.42 1.42l2.83 2.83a1 1 0 0 0 1.42 0l5-5a1 1 0 0 0 0-1.42zM20 12a8 8 0 1 1-8-8 8 8 0 0 1 8 8zm-2 0a6 6 0 1 0-6 6 6 6 0 0 0 6-6z"/></svg></span><span>Withdraw</span></button>
    <button class="nav-btn" id="navRefer"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18h14v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V18h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/></svg></span><span>Referrals</span></button>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Safety / Config ---
      const ADMIN_ID = 1849126202; // EDIT: replace with real admin ID
      const BOT_USERNAME = 'mysmartearn_bot'; // EDIT: your bot username
      const WEBAPP_NAME = 'mysmartearn'; // EDIT: your webapp short name

      const WITHDRAW_THRESHOLD = 10;      // 10 USDT
      const AD_REWARD_CENTS = 1;          // 0.01 USDT = 1 cent
      const REFERRAL_BONUS_USDT = 0.5;    // 0.5 USDT
      const DAILY_AD_LIMIT = 1000;

      const STORAGE_KEY = 'earningAppUSDTState_v1';

      // --- DOM ---
      const balanceDisplay = document.getElementById('balanceDisplay');
      const adCountDisplay = document.getElementById('adCountDisplay');
      const dailyAdCountDisplay = document.getElementById('dailyAdCountDisplay');
      const rewardedBtn = document.getElementById('rewardedBtn');
      const mainWithdrawBtn = document.getElementById('mainWithdrawBtn');
      const statusMessage = document.getElementById('statusMessage');
      const withdrawBalanceDisplay = document.getElementById('withdrawBalanceDisplay');
      const paymentAddressInput = document.getElementById('paymentAddress');
      const finalWithdrawBtn = document.getElementById('finalWithdrawBtn');
      const referralLinkDisplay = document.getElementById('referralLink');
      const referralCountDisplay = document.getElementById('referralCountDisplay');
      const referralBonusDisplay = document.getElementById('referralBonusDisplay');
      const adminPanel = document.getElementById('adminPanel');
      const userInfoDisplay = document.getElementById('userInfo');

      // --- NEW DOM: profile elements (added, no other logic changed) ---
      const profileRow = document.getElementById('profileRow');
      const profilePic = document.getElementById('profilePic').querySelector('img');
      const profileNameEl = document.getElementById('profileName');
      const profileSubEl = document.getElementById('profileSub');
      // --- end new DOM ---

      // --- State ---
      let state = {
        balanceInCents: 0,
        totalAdCount: 0,
        dailyAdCount: 0,
        lastAdDate: null,
        referralCount: 0
      };

      function getTodayDateString() {
        return new Date().toISOString().split('T')[0];
      }

      function loadState() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed && typeof parsed === 'object') {
              state = { ...state, ...parsed };
            }
          }
        } catch (e) {
          console.error('load state error', e);
        }
        // reset daily if needed
        const today = getTodayDateString();
        if (state.lastAdDate !== today) {
          state.dailyAdCount = 0;
          state.lastAdDate = today;
          saveState();
        }
      }

      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.error('save state error', e);
        }
      }

      // --- UI helpers ---
      function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        const v = document.getElementById(viewId);
        if (v) v.style.display = 'block';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const map = { 'home-view': 'navHome', 'withdraw-view': 'navWithdraw', 'referral-view': 'navRefer' };
        const activeNav = map[viewId];
        if (activeNav) {
          document.getElementById(activeNav).classList.add('active');
        }
      }

      let statusTimeout = null;
      function showStatus(msg, type = 'info', duration = 4000) {
        clearTimeout(statusTimeout);
        statusMessage.textContent = msg;
        statusMessage.className = `status-message ${type}`;
        statusMessage.style.display = 'block';
        statusTimeout = setTimeout(() => {
          statusMessage.style.display = 'none';
        }, duration);
      }

      function updateUI() {
        const balanceInUSDT = (state.balanceInCents / 100).toFixed(2);
        balanceDisplay.textContent = `USDT ${balanceInUSDT}`;
        adCountDisplay.textContent = state.totalAdCount;
        dailyAdCountDisplay.textContent = `${state.dailyAdCount} / ${DAILY_AD_LIMIT}`;
        withdrawBalanceDisplay.textContent = `USDT ${balanceInUSDT}`;

        referralCountDisplay.textContent = state.referralCount;
        referralBonusDisplay.textContent = `USDT ${(state.referralCount * REFERRAL_BONUS_USDT).toFixed(2)}`;

        const isWithdrawalPossible = parseFloat(balanceInUSDT) >= WITHDRAW_THRESHOLD;
        mainWithdrawBtn.disabled = !isWithdrawalPossible;
        mainWithdrawBtn.textContent = isWithdrawalPossible ? 'Go to Withdraw' : `Reach ${WITHDRAW_THRESHOLD.toFixed(2)} USDT to Withdraw`;

        finalWithdrawBtn.disabled = !isWithdrawalPossible;
        finalWithdrawBtn.textContent = isWithdrawalPossible ? `Withdraw ${balanceInUSDT} USDT` : `Minimum ${WITHDRAW_THRESHOLD.toFixed(2)} USDT required`;

        const adLimitReached = state.dailyAdCount >= DAILY_AD_LIMIT;
        rewardedBtn.disabled = adLimitReached;
        rewardedBtn.textContent = adLimitReached ? 'Daily Limit Reached' : 'Watch Ad (+0.01 USDT)';
      }

      // --- Ad handling (with guards) ---
      let adProcessing = false;
      let lastAdClick = 0;
      function requestAd() {
        if (adProcessing) return;
        if (state.dailyAdCount >= DAILY_AD_LIMIT) {
          showStatus("You've reached the daily ad limit.", 'error');
          return;
        }
        // simple click throttle
        const now = Date.now();
        if (now - lastAdClick < 1200) return;
        lastAdClick = now;

        showStatus('Loading ad, please wait...', 'info', 8000);
        adProcessing = true;
        rewardedBtn.disabled = true;

        // Ensure the ad SDK function exists and is callable
        try {
          const fn = window.show_10199498 || (window.libtl && window.libtl.show_10199498);
          if (!fn || typeof fn !== 'function') {
            throw new Error('Ad function not available');
          }

          // call and accept Promise or immediate result
          const result = fn();
          if (result && typeof result.then === 'function') {
            result.then(() => handleAdSuccess()).catch(err => handleAdError(err)).finally(() => { adProcessing = false; updateUI(); });
          } else {
            // non-promise result: assume success callback
            handleAdSuccess();
            adProcessing = false;
            updateUI();
          }
        } catch (err) {
          handleAdError(err);
          adProcessing = false;
          updateUI();
        }
      }

      function handleAdSuccess() {
        state.totalAdCount++;
        state.dailyAdCount++;
        state.lastAdDate = getTodayDateString();
        state.balanceInCents += AD_REWARD_CENTS;
        saveState();
        showStatus(`Success! +${(AD_REWARD_CENTS / 100).toFixed(2)} USDT has been added.`, 'success');
        updateUI();
      }

      function handleAdError(error) {
        console.error('Ad Error:', error);
        showStatus('Failed to load ad. Please try again.', 'error');
      }

      // --- Withdraw logic ---
      function isValidTronAddress(addr) {
        // Basic validation: TRON addresses start with 'T' and are 34-35 chars; this is a basic check only.
        if (typeof addr !== 'string') return false;
        const trimmed = addr.trim();
        return /^T[1-9A-HJ-NP-Za-km-z]{33,34}$/.test(trimmed);
      }

      function handleWithdrawal() {
        const balanceInUSDT = (state.balanceInCents / 100).toFixed(2);
        const walletAddress = paymentAddressInput.value.trim();

        if (parseFloat(balanceInUSDT) < WITHDRAW_THRESHOLD) {
          showStatus(`You need at least ${WITHDRAW_THRESHOLD.toFixed(2)} USDT to withdraw.`, 'error');
          return;
        }
        if (!isValidTronAddress(walletAddress)) {
          showStatus('Please enter a valid USDT (TRC20) wallet address.', 'error');
          return;
        }

        // Ensure Telegram WebApp available and initDataUnsafe exists
        const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
          showStatus('Telegram WebApp data not available. Please open via Telegram.', 'error');
          return;
        }

        // Build message for backend / admin via tg.sendData (client-side)
        const user = tg.initDataUnsafe.user;
        const message = [
          '--- Withdrawal Request ---',
          `User ID: ${user.id}`,
          `Name: ${user.first_name || ''} ${user.last_name || ''}`.trim(),
          `Username: @${user.username || 'N/A'}`,
          `Amount: ${balanceInUSDT} USDT`,
          `Wallet Address: ${walletAddress}`
        ].join('\n');

        try {
          // sendData just transmits to your bot's handler if you have it set up
          tg.sendData(message);
          showStatus('Your withdrawal request has been sent for review.', 'success');
          // reset balance locally (actual payout must be handled on backend)
          state.balanceInCents = 0;
          saveState();
          updateUI();
          paymentAddressInput.value = '';
          showView('home-view');
        } catch (e) {
          console.error('sendData error', e);
          showStatus('Failed to submit withdrawal. Try again later.', 'error');
        }
      }

      // --- Referral link generation ---
      function generateReferralLink() {
        const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
          referralLinkDisplay.textContent = "Referral link cannot be generated here. Open via Telegram.";
          referralLinkDisplay.style.cursor = 'default';
          return;
        }
        const user = tg.initDataUnsafe.user;
        if (user && user.id && BOT_USERNAME && WEBAPP_NAME) {
          // Example: t.me/<bot>/<webapp>?startapp=ref<id>
          const link = `https://t.me/${BOT_USERNAME}/${WEBAPP_NAME}?startapp=ref${user.id}`;
          referralLinkDisplay.textContent = link;
          referralLinkDisplay.dataset.link = link;
        } else {
          referralLinkDisplay.textContent = "Referral link cannot be generated. Configure bot info.";
          referralLinkDisplay.style.cursor = 'default';
        }
      }

      // --- Referral start handling (basic client-side only) ---
      function handleReferralStart() {
        const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        if (!tg) return;
        if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
          // Start param should be processed on backend to credit referrer.
          const refParam = String(tg.initDataUnsafe.start_param || '');
          if (refParam.startsWith('ref')) {
            const referrerId = refParam.replace('ref', '');
            console.log('Referral start param detected, referrerId=', referrerId);
            showStatus('Welcome! You joined via a referral link.', 'success', 4000);
          }
        }
      }

      // --- NEW: populate profile (non-invasive) ---
      function populateProfileIfAvailable() {
        try {
          const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
          if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
            // no Telegram user data ‚Äî leave profileRow hidden
            return;
          }
          const user = tg.initDataUnsafe.user;
          const displayName = (user.first_name || '') + (user.last_name ? (' ' + user.last_name) : '');
          const username = user.username ? ('@' + user.username) : '‚Äî';

          // Profile photo: Telegram WebApp's initDataUnsafe usually doesn't include photo URL.
          // If provider included it as user.photo_url we use it; otherwise fallback to a generated avatar.
          let photoUrl = (user.photo_url && typeof user.photo_url === 'string') ? user.photo_url : null;

          // If no photoUrl, use DiceBear identicon (random by user id or username)
          if (!photoUrl) {
            const seed = user.username || user.id || ('user' + Math.floor(Math.random() * 100000));
            // DiceBear 6.x API (svg). Use PNG-like URL by forcing format=png for broader compatibility.
            photoUrl = `https://api.dicebear.com/6.x/identicon/png?seed=${encodeURIComponent(seed)}&scale=100`;
          }

          // Set DOM
          profilePic.src = photoUrl;
          profilePic.alt = displayName || 'User';
          profileNameEl.textContent = displayName || (user.username ? ('@' + user.username) : 'Telegram User');
          profileSubEl.textContent = username;

          // show the profile row
          profileRow.style.display = 'flex';
        } catch (e) {
          console.warn('populateProfileIfAvailable error', e);
        }
      }
      // --- end new ---

      // --- Initialization ---
      function initializeApp() {
        // Wait until Telegram WebApp is available before trying to use it; if not, still continue with local features.
        const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        if (tg && typeof tg.ready === 'function') {
          try { tg.ready(); } catch (e) { console.warn('tg.ready failed', e); }
          try { tg.expand && tg.expand(); } catch (e) { /* ignore */ }
        }

        loadState();
        updateUI();
        generateReferralLink();
        handleReferralStart();

        // NEW: populate profile on home (non-invasive)
        populateProfileIfAvailable();

        // show admin panel if user is admin
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id === ADMIN_ID) {
          adminPanel.style.display = 'block';
          userInfoDisplay.textContent = `Welcome, Admin! User: ${tg.initDataUnsafe.user.first_name || ''} (@${tg.initDataUnsafe.user.username || 'N/A'}), ID: ${tg.initDataUnsafe.user.id}`;
        }
      }

      // --- Event listeners ---
      rewardedBtn.addEventListener('click', requestAd);
      finalWithdrawBtn.addEventListener('click', handleWithdrawal);
      document.getElementById('navHome').addEventListener('click', () => showView('home-view'));
      document.getElementById('navWithdraw').addEventListener('click', () => showView('withdraw-view'));
      document.getElementById('navRefer').addEventListener('click', () => showView('referral-view'));
      mainWithdrawBtn.addEventListener('click', () => showView('withdraw-view'));

      referralLinkDisplay.addEventListener('click', () => {
        const link = referralLinkDisplay.dataset.link;
        if (link && navigator.clipboard) {
          navigator.clipboard.writeText(link).then(() => showStatus('Referral link copied!', 'success')).catch(() => showStatus('Could not copy link.', 'error'));
        }
      });

      initializeApp();
    });
  </script>
</body>
</html>
